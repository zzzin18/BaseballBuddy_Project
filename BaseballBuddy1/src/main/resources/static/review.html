<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="logged-in-user-id" content="${loggedInUserId}" />
    <title>êµ¬ì¥ í›„ê¸° ê²Œì‹œíŒ</title>
    <style>
        /* ìŠ¤íƒ€ì¼ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ */
        body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          margin: 0;
          padding: 1.5rem;
          background-color: #f3f4f6;
          color: #111827;
        }
        main {
          max-width: 800px;
          margin: auto;
        }
        h1 {
          font-size: 1.75rem;
          font-weight: 700;
          margin-bottom: 1.5rem;
          text-align: center;
          color: #1f2937;
        }
        .flex {
          display: flex;
          flex-wrap: wrap;
          gap: 0.5rem;
          margin-bottom: 1rem;
          justify-content: center;
        }
        button {
          cursor: pointer;
          border: 1px solid #d1d5db;
          border-radius: 9999px;
          padding: 0.4rem 0.9rem;
          background-color: white;
          font-size: 0.9rem;
          transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        button:hover {
          background-color: #e5e7eb;
        }
        button.selected {
          background-color: #3b82f6;
          color: white;
          border-color: #3b82f6;
        }
        label {
          display: flex;
          align-items: center;
          gap: 0.4rem;
          font-size: 0.95rem;
          color: #374151;
          cursor: pointer;
        }
        .post {
          background-color: white;
          padding: 1rem;
          border: 1px solid #e5e7eb;
          border-radius: 0.75rem;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
          margin-bottom: 1rem;
        }
        .post img {
          margin-top: 0.75rem;
          max-width: 100%;
          border-radius: 0.5rem;
        }
        .write-btn {
          background-color: #10b981;
          color: white;
          border: none;
          border-radius: 0.5rem;
          padding: 0.6rem 1.2rem;
          font-size: 1rem;
          font-weight: 600;
          display: block;
          margin: 1rem auto;
        }
        .write-btn:hover {
          background-color: #059669;
        }
        #posts-container {
          margin-top: 1rem;
        }
        .like-btn {
          cursor: pointer;
          background-color: transparent;
          border: none;
          font-size: 1rem;
          color: #999;
          margin-top: 0.8rem;
          user-select: none;
          transition: color 0.3s ease;
        }
        .like-btn.liked {
          color: #ef4444; /* ë¹¨ê°„ìƒ‰ */
        }
        .like-btn:hover {
          color: #ef4444;
        }
    </style>
</head>
<body>
<main>
    <h1>êµ¬ì¥ í›„ê¸° ê²Œì‹œíŒ</h1>

    <div id="stadium-buttons" class="flex"></div>

    <div id="filter-checkboxes" class="flex"></div>

    <a href="/reviewPost.html">
        <button class="write-btn">ê¸€ ì‘ì„±</button>
    </a>

    <div id="posts-container"></div>
</main>

<script>
    const stadiumButtonsDiv = document.getElementById('stadium-buttons');
const filterCheckboxesDiv = document.getElementById('filter-checkboxes');
const postsContainer = document.getElementById('posts-container');

const stadiumMap = {
  INCHEON: "ì¸ì²œ",
  JAMSHIL: "ì ì‹¤",
  GOCHEOK: "ê³ ì²™",
  SUWON: "ìˆ˜ì›",
  DAEJEON: "ëŒ€ì „",
  DAEGU: "ëŒ€êµ¬",
  GWANGJU: "ê´‘ì£¼",
  BUSAN: "ë¶€ì‚°",
  CHANGWON: "ì°½ì›",
  ETC: "ê¸°íƒ€"
};

const filterTagMap = {
  FIRSTBASE: "1ë£¨",
  THIRDBASE: "3ë£¨",
  OUTFIELD: "ì™¸ì•¼",
  FOOD: "ìŒì‹",
  FACILITY: "ê³µìš©ì‹œì„¤",
  PARKING: "ì£¼ì°¨",
  GOODS: "êµ¿ì¦ˆìƒµ",
  ETC: "ê¸°íƒ€"
};

const stadiums = Object.keys(stadiumMap);
const filters = Object.keys(filterTagMap);

let selectedStadium = null;
let selectedFilters = [];

function renderStadiumButtons() {
  stadiumButtonsDiv.innerHTML = '';
  stadiums.forEach(stadium => {
    const btn = document.createElement('button');
    btn.textContent = stadiumMap[stadium];
    btn.className = (selectedStadium === stadium) ? 'selected' : '';
    btn.addEventListener('click', () => {
      selectedStadium = (selectedStadium === stadium) ? null : stadium;
      renderStadiumButtons();
      fetchFilteredPosts();
    });
    stadiumButtonsDiv.appendChild(btn);
  });
}

function renderFilterCheckboxes() {
  filterCheckboxesDiv.innerHTML = '';
  filters.forEach(filter => {
    const label = document.createElement('label');
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.value = filter;
    checkbox.checked = selectedFilters.includes(filter);
    checkbox.addEventListener('change', () => {
      if (selectedFilters.includes(filter)) {
        selectedFilters = selectedFilters.filter(f => f !== filter);
      } else {
        selectedFilters.push(filter);
      }
      fetchFilteredPosts();
    });
    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(filterTagMap[filter]));
    filterCheckboxesDiv.appendChild(label);
  });
}

function fetchFilteredPosts() {
  const params = new URLSearchParams();
  if (selectedStadium) params.append("stadium", selectedStadium);
  selectedFilters.forEach(f => params.append("filters", f));

  fetch(`/review-posts/filter?${params.toString()}`)
  .then(res => {
    if (!res.ok) {
      console.error("ì‘ë‹µ ì‹¤íŒ¨ ìƒíƒœ:", res.status);
      return Promise.reject("ì„œë²„ ì˜¤ë¥˜");
    }
    return res.json(); // â† ì´ì œ ì•ˆì „í•˜ê²Œ í˜¸ì¶œ ê°€ëŠ¥
  })
  .then(data => {
    console.log("ë°›ì€ ë°ì´í„°:", data);
    renderPosts(data);
  })
  .catch(err => {
    console.error("fetch ì—ëŸ¬:", err);
    postsContainer.textContent = "ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
  });
  }



function renderPosts(posts) {
  postsContainer.innerHTML = '';
  if (posts.length === 0) {
    postsContainer.textContent = 'ì¡°ê±´ì— ë§ëŠ” ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.';
    return;
  }

  posts.forEach(post => {
    const postDiv = document.createElement('div');
    postDiv.className = 'post';

    const title = document.createElement('h3');
    title.textContent = `[${stadiumMap[post.stadium] || post.stadium}] ${post.postTitle} - ${post.nickname || "ìµëª…"}`;
    postDiv.appendChild(title);

    const content = document.createElement('p');
    content.innerHTML = (post.postDetail || '').replace(/\n/g, '<br>');
    postDiv.appendChild(content);

    //ì¢‹ì•„ìš” ë²„íŠ¼
    const likeWrapper = document.createElement('div');
    likeWrapper.style.display = 'flex';
    likeWrapper.style.alignItems = 'center';
    likeWrapper.style.marginTop = '0.6rem';

    const likeBtn = document.createElement('button');
    likeBtn.className = 'like-btn';
    likeBtn.innerHTML = post.likedByCurrentUser ? 'â¤ï¸' : 'ğŸ¤';
    if (post.likedByCurrentUser) likeBtn.classList.add('liked');

    const likeCount = document.createElement('span');
    likeCount.textContent = ` ${post.likeCount}`;
    likeCount.style.marginLeft = '0.3rem';

    likeBtn.addEventListener('click', async () => {
      try {
        const res = await fetch(`/review-posts/${post.postId}/like`, { method: 'PUT' });
        if (!res.ok) throw new Error("ì¢‹ì•„ìš” ì‹¤íŒ¨");
        await fetchFilteredPosts(); // ë‹¤ì‹œ ê¸€ ëª©ë¡ ê°±ì‹ !
      } catch (err) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•˜ê±°ë‚˜ ì„œë²„ ì˜¤ë¥˜ì…ë‹ˆë‹¤.");
        console.error(err);
      }
    });

    likeWrapper.appendChild(likeBtn);
    likeWrapper.appendChild(likeCount);
    postDiv.appendChild(likeWrapper);

    postsContainer.appendChild(postDiv);
  });
}

renderStadiumButtons();
renderFilterCheckboxes();
fetchFilteredPosts(); // ìµœì´ˆ ë¡œë“œ ì‹œ ì „ì²´ ë¶ˆëŸ¬ì˜¤ê¸°

</script>

</body>
</html>
